/* jquery.dropotron.js v1.4.3 | (c) @ajlkn | github.com/ajlkn/jquery.dropotron | MIT licensed */
(function($) {

  // Funkce pro zakázání výběru textu v daném elementu
  $.fn.disableSelection_dropotron = function() {
      return $(this).css("user-select", "none")
                   .css("-khtml-user-select", "none")
                   .css("-moz-user-select", "none")
                   .css("-o-user-select", "none")
                   .css("-webkit-user-select", "none");
  };

  // Inicializace dropotronu
  $.fn.dropotron = function(settings) {
      if (this.length === 0) return $(this);
      if (this.length > 1) {
          for (var i = 0; i < this.length; i++) {
              $(this[i]).dropotron(settings);
          }
          return this;
      }
      return $.dropotron($.extend({ selectorParent: $(this) }, settings));
  };

  // Hlavní funkce dropotronu
  $.dropotron = function(options) {
      var settings = $.extend({
          selectorParent: null,
          baseZIndex: 1000,
          menuClass: "dropotron",
          expandMode: "hover",
          hoverDelay: 150,
          hideDelay: 250,
          openerClass: "opener",
          openerActiveClass: "active",
          submenuClassPrefix: "level-",
          mode: "fade",
          speed: "fast",
          easing: "swing",
          alignment: "left",
          offsetX: 0,
          offsetY: 0,
          globalOffsetY: 0,
          IEOffsetX: 0,
          IEOffsetY: 0,
          noOpenerFade: true,
          detach: true,
          cloneOnDetach: true
      }, options);

      var parent = settings.selectorParent,
          menus = parent.find("ul"),
          body = $("body"),
          doc = $("body,html"),
          windowElement = $(window),
          active = false,
          hoverTimeout = null,
          hideTimeout = null;

      // Skrýt všechny položky
      parent.on("doCollapseAll", function() {
          menus.trigger("doCollapse");
      });

      menus.each(function() {
          var menu = $(this),
              parentItem = menu.parent();

          // Skrýt menu po opuštění kurzoru
          if (settings.hideDelay > 0) {
              menu.add(parentItem).on("mouseleave", function() {
                  window.clearTimeout(hideTimeout);
                  hideTimeout = window.setTimeout(function() {
                      menu.trigger("doCollapse");
                  }, settings.hideDelay);
              });
          }

          menu.disableSelection_dropotron()
              .hide()
              .addClass(settings.menuClass)
              .css("position", "absolute")
              .on("mouseenter", function() {
                  window.clearTimeout(hideTimeout);
              })
              .on("doExpand", function() {
                  if (menu.is(":visible")) return false;

                  window.clearTimeout(hideTimeout);
                  menus.each(function() {
                      var m = $(this);
                      if (!$.contains(m.get(0), parentItem.get(0))) {
                          m.trigger("doCollapse");
                      }
                  });

                  var offsetParent = settings.detach ? parentItem.offset() : parentItem.position(),
                      top = offsetParent.top + parentItem.outerHeight() + settings.globalOffsetY,
                      left = offsetParent.left,
                      alignment = settings.alignment;

                  if (settings.detach) {
                      switch (alignment) {
                          case "right":
                              left -= menu.outerWidth() - parentItem.outerWidth();
                              break;
                          case "center":
                              left -= Math.floor((menu.outerWidth() - parentItem.outerWidth()) / 2);
                              break;
                          case "left":
                          default:
                              break;
                      }
                  } else {
                      top = settings.offsetY;
                      left = settings.alignment === "right" ? -parentItem.outerWidth() + settings.offsetX : settings.offsetX;
                  }

                  // Zajištění zobrazení menu na obrazovce
                  if (menu.offset().left < 0) {
                      left += parentItem.outerWidth() - settings.offsetX;
                  } else if (menu.offset().left + menu.outerWidth() > windowElement.width()) {
                      left -= parentItem.outerWidth() + settings.offsetX;
                  }

                  menu.css("left", left + "px")
                      .css("top", top + "px")
                      .css("opacity", "0.01")
                      .show();

                  var showMenu = function() {
                      menu.css("opacity", "1");
                      active = false;
                  };

                  // Zobrazení menu podle zvoleného režimu
                  switch (settings.mode) {
                      case "zoom":
                          active = true;
                          parentItem.addClass(settings.openerActiveClass);
                          menu.animate({ width: "toggle", height: "toggle" }, settings.speed, settings.easing, showMenu);
                          break;
                      case "slide":
                          active = true;
                          parentItem.addClass(settings.openerActiveClass);
                          menu.animate({ height: "toggle" }, settings.speed, settings.easing, showMenu);
                          break;
                      case "fade":
                          active = true;
                          if (settings.noOpenerFade) {
                              parentItem.addClass(settings.openerActiveClass);
                              menu.fadeIn(settings.speed, showMenu);
                          } else {
                              parentItem.fadeTo(settings.speed / 2, 0.01, function() {
                                  parentItem.addClass(settings.openerActiveClass);
                                  parentItem.fadeTo(settings.speed, 1);
                                  menu.fadeIn(settings.speed, showMenu);
                              });
                          }
                          break;
                      case "instant":
                      default:
                          parentItem.addClass(settings.openerActiveClass);
                          menu.show();
                          showMenu();
                          break;
                  }

                  return false;
              })
              .on("doCollapse", function() {
                  if (!menu.is(":visible")) return false;
                  menu.hide();
                  parentItem.removeClass(settings.openerActiveClass);
                  menu.find("." + settings.openerActiveClass).removeClass(settings.openerActiveClass);
                  menu.find("ul").hide();
                  return false;
              })
              .on("doToggle", function() {
                  return menu.is(":visible") ? menu.trigger("doCollapse") : menu.trigger("doExpand"), false;
              });

          // Otevření menu na klik
          parentItem.disableSelection_dropotron()
              .addClass("opener")
              .css("cursor", "pointer")
              .on("click touchend", function(e) {
                  if (!active) {
                      e.preventDefault();
                      e.stopPropagation();
                      menu.trigger("doToggle");
                  }
              });

          // Otevření menu na hover, pokud je nastavený hover režim
          if (settings.expandMode === "hover") {
              parentItem.hover(function() {
                  if (!active) {
                      hoverTimeout = window.setTimeout(function() {
                          menu.trigger("doExpand");
                      }, settings.hoverDelay);
                  }
              }, function() {
                  window.clearTimeout(hoverTimeout);
              });
          }
      });

      // Kliknutí na odkaz uvnitř menu
      menus.find("a").css("display", "block").on("click touchend", function(e) {
          if (!active && $(this).attr("href").length < 1) e.preventDefault();
      });

      // Ošetření kliknutí na prázdné odkazy
      parent.find("li").css("white-space", "nowrap").each(function() {
          var listItem = $(this),
              anchor = listItem.children("a"),
              subMenu = listItem.children("ul"),
              href = anchor.attr("href");

          anchor.on("click touchend", function(e) {
              if (href.length === 0 || href === "#") {
                  e.preventDefault();
              } else {
                  e.stopPropagation();
              }
          });

          if (anchor.length > 0 && subMenu.length === 0) {
              listItem.on("click touchend", function(e) {
                  if (!active) {
                      parent.trigger("doCollapseAll");
                      e.stopPropagation();
                  }
              });
          }
      });

      // Nastavení z-indexů pro submenu
      parent.children("li").each(function() {
          var listItem = $(this),
              subMenu = listItem.children("ul");

          if (subMenu.length > 0) {
              if (settings.detach) {
                  if (settings.cloneOnDetach) {
                      var clone = subMenu.clone();
                      clone.attr("class", "").hide().appendTo(subMenu.parent());
                  }
                  subMenu.detach().appendTo(body);
              }

              for (var zIndex = settings.baseZIndex, level = 1, currentMenu = subMenu; currentMenu.length > 0; level++) {
                  currentMenu.css("z-index", zIndex++);
                  if (settings.submenuClassPrefix) {
                      currentMenu.addClass(settings.submenuClassPrefix + (zIndex - 1 - settings.baseZIndex));
                  }
                  currentMenu = currentMenu.find("> li > ul");
              }
          }
      });

      // Skrývání všech menu při scrollování nebo stisknutí klávesy ESC
      windowElement.on("scroll", function() {
          parent.trigger("doCollapseAll");
      }).on("keypress", function(e) {
          if (!active && e.keyCode === 27) {
              e.preventDefault();
              parent.trigger("doCollapseAll");
          }
      });

      // Skrývání všech menu při kliknutí mimo menu
      doc.on("click touchend", function() {
          if (!active) {
              parent.trigger("doCollapseAll");
          }
      });
  };
})(jQuery);
